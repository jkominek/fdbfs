name: C/C++ CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  build:
    environment: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: apt-get
      run: sudo apt-get update ; sudo apt-get -y install libfuse3-dev fuse3 libprotobuf-dev protobuf-compiler liblz4-dev python3-protobuf libzstd1 libzstd-dev libattr1-dev libacl1-dev s3cmd valgrind nlohmann-json3-dev meson python3-pip catch2
    - name: pip
      run: sudo env PATH=$PATH pip install zstd==1.5.7.3
    - name: fetch fdb
      run: wget https://github.com/apple/foundationdb/releases/download/7.3.69/foundationdb-{clients,server}_7.3.69-1_amd64.deb
    - name: dpkg install
      run: sudo dpkg -i foundationdb-*_7.*-1_amd64.deb
    - name: fdb setup
      run: sudo cp tests/foundationdb.conf /etc/foundationdb/ ; sudo systemctl restart foundationdb
    - name: meson
      run: meson setup build
    - name: ninja
      run: ninja -C build
    - name: mkfs
      run: ./regen.sh
    - name: test.sh
      run: ./test.sh
    - name: meson integration tests
      id: meson_integration
      continue-on-error: true
      run: meson test -C build --no-rebuild --print-errorlogs --maxfail 1
    - name: secfs.test
      id: secfs_test
      continue-on-error: true
      run: ./runsecfs.sh
    - name: upload integration artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: ci-artifacts-${{ github.run_id }}
        if-no-files-found: warn
        retention-days: 14
        path: |
          /tmp/fdbfs-tests
          build/meson-logs/testlog.txt
          /tmp/valgrind.txt
    - name: enforce test outcomes
      if: ${{ always() }}
      run: |
        status=0
        if [ "${{ steps.secfs_test.outcome }}" = "failure" ]; then
          echo "secfs.test failed"
          status=1
        fi
        if [ "${{ steps.meson_integration.outcome }}" = "failure" ]; then
          echo "meson integration tests failed"
          status=1
        fi
        exit "$status"
