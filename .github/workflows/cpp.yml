name: C/C++ CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  build:
    environment: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: apt-get
      run: sudo apt-get -y install libfuse-dev fuse libprotobuf-dev protobuf-compiler liblz4-dev python-protobuf libzstd1 libzstd-dev libattr1-dev libacl1-dev s3cmd valgrind nlohmann-json3-dev meson
    - name: pip
      run: sudo env PATH=$PATH pip install zstd==1.4.9.1
    - name: fetch fdb
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: s3cmd get s3://fdbfs-build-assets/{foundationdb-clients_6.3.18-1_amd64.deb,foundationdb-server_6.3.18-1_amd64.deb}
    - name: dpkg install
      run: sudo dpkg -i foundationdb-clients_6.3.18-1_amd64.deb foundationdb-server_6.3.18-1_amd64.deb
    - name: meson
      run: meson setup build
    - name: ninja
      run: ninja -C build
    - name: mkfs
      run: ./regen.sh
    - name: test.sh
      run: ./test.sh
    - name: secfs.test
      run: ./runsecfs.sh
